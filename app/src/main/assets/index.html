<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ø´Ø®ØµÛŒ v2</title>
  <style>
    :root{
      --bg:#070b16;
      --bg2:#0b1430;
      --card:#0f1b33;
      --card2:#0c162b;
      --text:#eef4ff;
      --muted:#9fb0d3;
      --border:rgba(255,255,255,.10);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:20px;
      --accent:#7aa9ff;
      --good:#45d59c;
      --bad:#ff6b7a;
      --warn:#ffcc66;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Vazirmatn", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--font);
      background:
        radial-gradient(1000px 600px at 70% -10%, rgba(122,169,255,.25), transparent 60%),
        radial-gradient(900px 540px at 20% 0%, rgba(69,213,156,.16), transparent 55%),
        radial-gradient(900px 540px at 80% 60%, rgba(255,107,122,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px; height:44px; border-radius:16px;
      background:linear-gradient(135deg, rgba(122,169,255,.95), rgba(69,213,156,.85));
      box-shadow:0 14px 28px rgba(122,169,255,.18);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-40%;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 45%);
      transform:rotate(25deg);
    }
    .brand h1{margin:0; font-size:16px; font-weight:900}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}

    .topRight{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    .tabs{
      display:flex; gap:8px; padding:6px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.12);
    }
    .tab{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      transition:.15s transform,.15s background,.15s color;
      display:inline-flex; gap:8px; align-items:center;
    }
    .tab:hover{transform:translateY(-1px); color:var(--text)}
    .tab.active{
      background:linear-gradient(135deg, rgba(122,169,255,.35), rgba(122,169,255,.14));
      color:var(--text);
      box-shadow:0 10px 22px rgba(122,169,255,.12);
    }

    button,.btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border-color;
      font-weight:900;
    }
    button:hover,.btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
    .primary{
      background:linear-gradient(135deg, rgba(122,169,255,.9), rgba(122,169,255,.55));
      border-color: rgba(122,169,255,.35);
    }
    .danger{
      background:linear-gradient(135deg, rgba(255,107,122,.35), rgba(255,107,122,.10));
      border-color: rgba(255,107,122,.35);
    }
    .ghost{background:rgba(255,255,255,.03)}
    .grid{display:grid; gap:14px; margin-top:14px}
    .stats{grid-template-columns:repeat(4, minmax(0,1fr))}
    @media (max-width:980px){
      .stats{grid-template-columns:repeat(2, minmax(0,1fr))}
      header{position:static}
    }
    .panel{grid-template-columns: 1.55fr 1fr}
    @media (max-width:980px){.panel{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(0,0,0,.10), transparent);
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .bd{padding:14px}
    .stat{padding:14px}
    .kpi{font-size:12px; color:var(--muted); margin-bottom:6px}
    .val{font-size:18px; font-weight:1000; letter-spacing:.2px}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}

    .pill{
      font-size:12px; font-weight:1000;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      display:inline-flex; gap:6px; align-items:center;
      white-space:nowrap;
    }
    .pill.good{border-color:rgba(69,213,156,.35); color:#d4ffef}
    .pill.bad{border-color:rgba(255,107,122,.35); color:#ffe1e4}
    .pill.warn{border-color:rgba(255,204,102,.35); color:#fff2d0}

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}

    .formGrid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px}
    @media (max-width:720px){.formGrid{grid-template-columns:1fr}}
    .hr{height:1px; background:var(--border); margin:12px 0}

    .table{width:100%; border-collapse:separate; border-spacing:0; font-size:13px}
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:right;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-size:12px; font-weight:1000}
    .nowrap{white-space:nowrap}

    .amount.in{color:#c7ffe8; font-weight:1000}
    .amount.out{color:#ffd1d6; font-weight:1000}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-size:12px; color:var(--text);
      white-space:nowrap;
    }
    .muted{color:var(--muted)}
    .small{font-size:12px}

    .tools{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .iconBtn{padding:8px 10px; border-radius:12px; font-size:12px; font-weight:1000}

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }

    canvas{width:100%; height:220px; background:rgba(0,0,0,.12); border:1px solid var(--border); border-radius:16px}

    /* pages */
    .page{display:none}
    .page.active{display:block}

    /* modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.58);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:30;
      backdrop-filter: blur(6px);
    }
    .modal.open{display:flex}
    .modal .box{
      width:min(780px, 100%);
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(15,27,51,.98), rgba(15,27,51,.92));
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .box .top{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid var(--border)
    }
    .modal .box .top h3{margin:0; font-size:14px}
    .modal .box .content{padding:14px}

    .toast{
      position:fixed; bottom:18px; left:18px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(15,27,51,.92);
      color:var(--text);
      display:none;
      box-shadow:var(--shadow);
      max-width:min(420px, calc(100vw - 36px));
      font-weight:900; font-size:13px;
    }
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ø´Ø®ØµÛŒ</h1>
          <p>v2 â€¢ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ + Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨ â€¢ Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±</p>
        </div>
      </div>

      <div class="topRight">
        <div class="tabs" role="tablist" aria-label="tabs">
          <button class="tab active" id="tabTx" role="tab">ğŸ’³ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</button>
          <button class="tab" id="tabDebt" role="tab">ğŸ¤ Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨</button>
        </div>

        <button class="primary" id="btnAddMain">ï¼‹ Ø«Ø¨Øª</button>
        <button class="ghost" id="btnBackup">Ø¨Ú©Ø§Ù¾ (JSON)</button>
        <button class="ghost" id="btnRestore">ÙˆØ±ÙˆØ¯ Ø¨Ú©Ø§Ù¾</button>
        <button class="danger" id="btnReset">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</button>
      </div>
    </header>

    <!-- TRANSACTIONS PAGE -->
    <div class="page active" id="pageTx">
      <section class="grid stats">
        <div class="card stat">
          <div class="kpi">Ø¬Ù…Ø¹ Ø¯Ø±Ø¢Ù…Ø¯ (Ù…Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡)</div>
          <div class="val" id="kpiIncome">Û°</div>
          <div class="hint">Ù†ÙˆØ¹ Â«Ø¯Ø±Ø¢Ù…Ø¯Â»</div>
        </div>
        <div class="card stat">
          <div class="kpi">Ø¬Ù…Ø¹ Ù‡Ø²ÛŒÙ†Ù‡ (Ù…Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡)</div>
          <div class="val" id="kpiExpense">Û°</div>
          <div class="hint">Ù†ÙˆØ¹ Â«Ù‡Ø²ÛŒÙ†Ù‡Â»</div>
        </div>
        <div class="card stat">
          <div class="kpi">Ø®Ø§Ù„Øµ (Ø¯Ø±Ø¢Ù…Ø¯ - Ù‡Ø²ÛŒÙ†Ù‡)</div>
          <div class="val" id="kpiNet">Û°</div>
          <div class="hint">Ù…Ø«Ø¨Øª ÛŒØ¹Ù†ÛŒ Ø¬Ù„Ùˆ Ù‡Ø³ØªÛŒ</div>
        </div>
        <div class="card stat">
          <div class="kpi">ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</div>
          <div class="val" id="kpiCount">Û°</div>
          <div class="hint">Ø¨Ø±Ø§Ø³Ø§Ø³ ÙÛŒÙ„ØªØ±Ù‡Ø§</div>
        </div>
      </section>

      <section class="grid panel">
        <div class="card">
          <div class="hd">
            <h2>ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h2>
            <span class="pill" id="activeMonthPill">Ù…Ø§Ù‡: â€”</span>
          </div>
          <div class="bd">
            <div class="row">
              <div style="flex:1; min-width:180px">
                <label>Ø¬Ø³ØªØ¬Ùˆ</label>
                <input id="q" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø®Ø±ÛŒØ¯ØŒ Ø­Ù‚ÙˆÙ‚ØŒ Ù‚Ø¨Ø¶..." />
              </div>
              <div style="width:170px">
                <label>Ù…Ø§Ù‡</label>
                <input id="month" type="month" />
              </div>
              <div style="width:160px">
                <label>Ù†ÙˆØ¹</label>
                <select id="typeFilter">
                  <option value="all">Ù‡Ù…Ù‡</option>
                  <option value="income">Ø¯Ø±Ø¢Ù…Ø¯</option>
                  <option value="expense">Ù‡Ø²ÛŒÙ†Ù‡</option>
                </select>
              </div>
              <div style="width:190px">
                <label>Ø¯Ø³ØªÙ‡</label>
                <select id="catFilter"></select>
              </div>
            </div>

            <div class="hr"></div>

            <div style="overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th class="nowrap">ØªØ§Ø±ÛŒØ®</th>
                    <th>Ù†ÙˆØ¹</th>
                    <th>Ø¯Ø³ØªÙ‡</th>
                    <th>Ø­Ø³Ø§Ø¨</th>
                    <th>Ø´Ø±Ø­</th>
                    <th class="nowrap">Ù…Ø¨Ù„Øº</th>
                    <th class="nowrap">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                  </tr>
                </thead>
                <tbody id="txBody"></tbody>
              </table>
            </div>

            <div class="small muted" style="margin-top:10px">
              Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø² Ø¨Ú©Ø§Ù¾ JSON Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡</h2>
            <span class="pill" id="netPill">â€”</span>
          </div>
          <div class="bd">
            <canvas id="chart" width="600" height="260"></canvas>
            <div class="hr"></div>
            <div class="row">
              <div style="flex:1; min-width:220px">
                <div class="kpi">Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù‡Ø²ÛŒÙ†Ù‡</div>
                <div class="val" id="topExpenseCat">â€”</div>
                <div class="hint" id="topExpenseHint">â€”</div>
              </div>
              <div style="flex:1; min-width:220px">
                <div class="kpi">Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¯Ø±Ø¢Ù…Ø¯</div>
                <div class="val" id="topIncomeCat">â€”</div>
                <div class="hint" id="topIncomeHint">â€”</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- DEBTS PAGE -->
    <div class="page" id="pageDebt">
      <section class="grid stats">
        <div class="card stat">
          <div class="kpi">Ø¬Ù…Ø¹ Ø·Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø² (Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¨Ù‡ ØªÙˆ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ù†Ø¯)</div>
          <div class="val" id="kpiRecv">Û°</div>
          <div class="hint">Receivable</div>
        </div>
        <div class="card stat">
          <div class="kpi">Ø¬Ù…Ø¹ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø² (ØªÙˆ Ø¨Ø¯Ù‡Ú©Ø§Ø±ÛŒ)</div>
          <div class="val" id="kpiPay">Û°</div>
          <div class="hint">Payable</div>
        </div>
        <div class="card stat">
          <div class="kpi">Ø®Ø§Ù„Øµ Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨</div>
          <div class="val" id="kpiDebtNet">Û°</div>
          <div class="hint">Ù…Ø«Ø¨Øª ÛŒØ¹Ù†ÛŒ Ø·Ù„Ø¨Ú©Ø§Ø± Ù‡Ø³ØªÛŒ</div>
        </div>
        <div class="card stat">
          <div class="kpi">Ù…ÙˆØ§Ø±Ø¯ Ø³Ø±Ø±Ø³ÛŒØ¯ Ú¯Ø°Ø´ØªÙ‡</div>
          <div class="val" id="kpiOverdue">Û°</div>
          <div class="hint">ÙÙ‚Ø· ÙˆØ¶Ø¹ÛŒØª Â«Ø¨Ø§Ø²Â»</div>
        </div>
      </section>

      <section class="grid" style="grid-template-columns:1fr">
        <div class="card">
          <div class="hd">
            <h2>Ø¯ÙØªØ± Ø¨Ø¯Ù‡ÛŒ / Ø·Ù„Ø¨</h2>
            <span class="pill" id="debtPill">â€”</span>
          </div>
          <div class="bd">
            <div class="row">
              <div style="flex:1; min-width:220px">
                <label>Ø¬Ø³ØªØ¬Ùˆ (Ù†Ø§Ù…/Ø´Ø±Ø­)</label>
                <input id="dq" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒØŒ ÙˆØ§Ù…ØŒ Ù‚Ø±Ø¶..." />
              </div>
              <div style="width:180px">
                <label>Ù†ÙˆØ¹</label>
                <select id="dDir">
                  <option value="all">Ù‡Ù…Ù‡</option>
                  <option value="receivable">Ø·Ù„Ø¨ (Ø¨Ù‡ Ù†ÙØ¹ ØªÙˆ)</option>
                  <option value="payable">Ø¨Ø¯Ù‡ÛŒ (Ø¨Ù‡ Ø¶Ø±Ø± ØªÙˆ)</option>
                </select>
              </div>
              <div style="width:160px">
                <label>ÙˆØ¶Ø¹ÛŒØª</label>
                <select id="dStatus">
                  <option value="open">Ø¨Ø§Ø²</option>
                  <option value="all">Ù‡Ù…Ù‡</option>
                  <option value="settled">ØªØ³ÙˆÛŒÙ‡â€ŒØ´Ø¯Ù‡</option>
                </select>
              </div>
              <div style="width:180px">
                <label>Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ</label>
                <select id="dSort">
                  <option value="due_asc">Ø³Ø±Ø±Ø³ÛŒØ¯ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±</option>
                  <option value="amount_desc">Ù…Ø¨Ù„Øº Ø¨ÛŒØ´ØªØ±</option>
                  <option value="created_desc">Ø¬Ø¯ÛŒØ¯ØªØ±</option>
                </select>
              </div>
            </div>

            <div class="hr"></div>

            <div style="overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>Ø´Ø®Øµ/Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„</th>
                    <th class="nowrap">Ù†ÙˆØ¹</th>
                    <th class="nowrap">Ø´Ø±ÙˆØ¹</th>
                    <th class="nowrap">Ø³Ø±Ø±Ø³ÛŒØ¯</th>
                    <th class="nowrap">Ù…Ø¨Ù„Øº</th>
                    <th class="nowrap">ÙˆØ¶Ø¹ÛŒØª</th>
                    <th class="nowrap">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                  </tr>
                </thead>
                <tbody id="debtBody"></tbody>
              </table>
            </div>

            <div class="small muted" style="margin-top:10px">
              Ù†Ú©ØªÙ‡: Ø¨Ø§ Â«ØªØ³ÙˆÛŒÙ‡Â» Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) ÛŒÚ© ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø±Ø¢Ù…Ø¯/Ù‡Ø²ÛŒÙ†Ù‡ Ù‡Ù… Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø«Ø¨Øª Ú©Ù†ÛŒ.
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal: Transaction -->
  <div class="modal" id="modalTx">
    <div class="box" role="dialog" aria-modal="true">
      <div class="top">
        <div style="display:flex; gap:10px; align-items:center">
          <span class="pill" id="txModePill">Ø«Ø¨Øª</span>
          <h3 id="txModalTitle">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</h3>
        </div>
        <button class="iconBtn" id="txClose">âœ• Ø¨Ø³ØªÙ†</button>
      </div>
      <div class="content">
        <div class="formGrid">
          <div>
            <label>ØªØ§Ø±ÛŒØ®</label>
            <input type="date" id="fDate" />
          </div>
          <div>
            <label>Ù†ÙˆØ¹</label>
            <select id="fType">
              <option value="expense">Ù‡Ø²ÛŒÙ†Ù‡</option>
              <option value="income">Ø¯Ø±Ø¢Ù…Ø¯</option>
            </select>
          </div>
          <div>
            <label>Ø¯Ø³ØªÙ‡</label>
            <select id="fCategory"></select>
          </div>
          <div>
            <label>Ø­Ø³Ø§Ø¨</label>
            <select id="fAccount"></select>
          </div>
          <div>
            <label>Ù…Ø¨Ù„Øº (Ø¹Ø¯Ø¯)</label>
            <input type="number" id="fAmount" min="0" step="1" placeholder="Ù…Ø«Ù„Ø§Ù‹ 150000" />
            <div class="hint">ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø®ÙˆØ¯Øª Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ± (Ù…Ø«Ù„Ø§Ù‹ ØªÙˆÙ…Ø§Ù†)</div>
          </div>
          <div>
            <label>Ø´Ø±Ø­</label>
            <input id="fNote" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯ ØºØ°Ø§ÛŒÛŒ / Ø­Ù‚ÙˆÙ‚ / Ù‚Ø¨Ø¶..." />
          </div>
        </div>

        <div class="hr"></div>

        <div class="tools">
          <button id="txSave" class="primary">Ø°Ø®ÛŒØ±Ù‡</button>
          <button id="txCancel">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Debt -->
  <div class="modal" id="modalDebt">
    <div class="box" role="dialog" aria-modal="true">
      <div class="top">
        <div style="display:flex; gap:10px; align-items:center">
          <span class="pill" id="dModePill">Ø«Ø¨Øª</span>
          <h3 id="dModalTitle">Ø«Ø¨Øª Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨</h3>
        </div>
        <button class="iconBtn" id="dClose">âœ• Ø¨Ø³ØªÙ†</button>
      </div>
      <div class="content">
        <div class="formGrid">
          <div>
            <label>Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ (Ù†Ø§Ù… Ø´Ø®Øµ/Ù…Ø¤Ø³Ø³Ù‡)</label>
            <input id="dfPerson" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø¹Ù„ÛŒ / Ø¨Ø§Ù†Ú© / Ø´Ø±Ú©Øª..." />
          </div>
          <div>
            <label>Ù†ÙˆØ¹</label>
            <select id="dfDir">
              <option value="receivable">Ø·Ù„Ø¨ (Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¨Ù‡ Ù…Ù† Ø¨Ø¯Ù‡Ú©Ø§Ø±Ù†Ø¯)</option>
              <option value="payable">Ø¨Ø¯Ù‡ÛŒ (Ù…Ù† Ø¨Ø¯Ù‡Ú©Ø§Ø±Ù…)</option>
            </select>
          </div>
          <div>
            <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
            <input type="date" id="dfStart" />
          </div>
          <div>
            <label>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <input type="date" id="dfDue" />
          </div>
          <div>
            <label>Ù…Ø¨Ù„Øº</label>
            <input type="number" id="dfAmount" min="0" step="1" placeholder="Ù…Ø«Ù„Ø§Ù‹ 2000000" />
          </div>
          <div>
            <label>ÙˆØ¶Ø¹ÛŒØª</label>
            <select id="dfStatus">
              <option value="open">Ø¨Ø§Ø²</option>
              <option value="settled">ØªØ³ÙˆÛŒÙ‡â€ŒØ´Ø¯Ù‡</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
            <textarea id="dfNote" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ù‚Ø±Ø¶ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ú¯ÙˆØ´ÛŒØŒ Ù‚Ø³Ø· Ø§ÙˆÙ„ØŒ ..."></textarea>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tools">
          <button id="dSave" class="primary">Ø°Ø®ÛŒØ±Ù‡</button>
          <button id="dCancel">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
      </div>
    </div>
  </div>

  <!-- hidden file input for restore -->
  <input type="file" id="restoreFile" accept="application/json" style="display:none" />
  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // Personal Accounting v2
    // =========================

    const STORAGE_KEY = "personal_accounting_v2";

    const DEFAULT_CATEGORIES = [
      "Ù…ÙˆØ§Ø¯ ØºØ°Ø§ÛŒÛŒ","Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„","Ù‚Ø¨Ø¶â€ŒÙ‡Ø§","ØªÙØ±ÛŒØ­","Ø³Ù„Ø§Ù…Øª","Ø¢Ù…ÙˆØ²Ø´","Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²","Ø­Ù‚ÙˆÙ‚","Ø³Ø§ÛŒØ±","ØªØ³ÙˆÛŒÙ‡ Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨"
    ];
    const DEFAULT_ACCOUNTS = ["Ù†Ù‚Ø¯ÛŒ","Ú©Ø§Ø±Øª","Ø¨Ø§Ù†Ú©","Ú©ÛŒÙ Ù¾ÙˆÙ„"];

    const state = {
      transactions: [],
      debts: [],
      editingTxId: null,
      editingDebtId: null,
      activeTab: "tx",
      filters: { q:"", month:"", type:"all", category:"all" },
      debtFilters: { q:"", dir:"all", status:"open", sort:"due_asc" }
    };

    const el = (id)=>document.getElementById(id);
    const nf = new Intl.NumberFormat("fa-IR");

    const toast = el("toast");
    let toastTimer=null;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>toast.classList.remove("show"),2400);
    }

    function pad(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d=new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function monthISO(dateISO){ return String(dateISO||"").slice(0,7); }
    function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function load(){
      // Ù…Ù‡Ø§Ø¬Ø±Øª Ø§Ø² v1 Ù‡Ù… Ù¾ÙˆØ´Ø´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
      const raw2 = localStorage.getItem(STORAGE_KEY);
      if(raw2){
        try{
          const p = JSON.parse(raw2);
          state.transactions = Array.isArray(p.transactions) ? p.transactions : [];
          state.debts = Array.isArray(p.debts) ? p.debts : [];
          return;
        }catch{}
      }

      const raw1 = localStorage.getItem("personal_accounting_v1");
      if(raw1){
        try{
          const p = JSON.parse(raw1);
          state.transactions = Array.isArray(p.transactions) ? p.transactions : [];
          state.debts = [];
          save(); // Ø¨Ù‡ v2 Ù…Ù†ØªÙ‚Ù„ Ú©Ù†
          return;
        }catch{}
      }

      state.transactions = [];
      state.debts = [];
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        version:2,
        transactions: state.transactions,
        debts: state.debts
      }));
    }

    function seed(){
      const now=new Date();
      state.filters.month = `${now.getFullYear()}-${pad(now.getMonth()+1)}`;
      el("month").value = state.filters.month;
      el("fDate").value = todayISO();
      el("dfStart").value = todayISO();
      el("dfDue").value = "";
    }

    function fillDropdowns(){
      el("catFilter").innerHTML = `<option value="all">Ù‡Ù…Ù‡</option>` +
        DEFAULT_CATEGORIES.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

      el("fCategory").innerHTML = DEFAULT_CATEGORIES
        .map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

      el("fAccount").innerHTML = DEFAULT_ACCOUNTS
        .map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join("");
    }

    // ---------- Tabs ----------
    function setTab(tab){
      state.activeTab = tab;
      el("tabTx").classList.toggle("active", tab==="tx");
      el("tabDebt").classList.toggle("active", tab==="debt");
      el("pageTx").classList.toggle("active", tab==="tx");
      el("pageDebt").classList.toggle("active", tab==="debt");

      el("btnAddMain").textContent = tab==="tx" ? "ï¼‹ Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´" : "ï¼‹ Ø«Ø¨Øª Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨";
      render();
    }

    el("tabTx").addEventListener("click", ()=>setTab("tx"));
    el("tabDebt").addEventListener("click", ()=>setTab("debt"));

    // ---------- Transaction modal ----------
    const modalTx = el("modalTx");
    function openTxModal(mode, tx=null){
      modalTx.classList.add("open");
      if(mode==="add"){
        state.editingTxId=null;
        el("txModePill").textContent="Ø«Ø¨Øª";
        el("txModalTitle").textContent="Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´";
        el("fDate").value=todayISO();
        el("fType").value="expense";
        el("fCategory").value=DEFAULT_CATEGORIES[0];
        el("fAccount").value=DEFAULT_ACCOUNTS[0];
        el("fAmount").value="";
        el("fNote").value="";
      }else{
        state.editingTxId=tx.id;
        el("txModePill").textContent="ÙˆÛŒØ±Ø§ÛŒØ´";
        el("txModalTitle").textContent="ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´";
        el("fDate").value=tx.date;
        el("fType").value=tx.type;
        el("fCategory").value=tx.category;
        el("fAccount").value=tx.account;
        el("fAmount").value=tx.amount;
        el("fNote").value=tx.note||"";
      }
      setTimeout(()=>el("fAmount").focus(),0);
    }
    function closeTxModal(){ modalTx.classList.remove("open"); }

    el("txClose").addEventListener("click", closeTxModal);
    el("txCancel").addEventListener("click", closeTxModal);
    modalTx.addEventListener("click",(e)=>{ if(e.target===modalTx) closeTxModal(); });

    function validateTx(){
      const date=el("fDate").value?.trim();
      const type=el("fType").value;
      const category=el("fCategory").value;
      const account=el("fAccount").value;
      const amount=Number(el("fAmount").value);
      const note=el("fNote").value?.trim()||"";

      if(!date) return {ok:false,msg:"ØªØ§Ø±ÛŒØ® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
      if(type!=="income" && type!=="expense") return {ok:false,msg:"Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª."};
      if(!category) return {ok:false,msg:"Ø¯Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†."};
      if(!account) return {ok:false,msg:"Ø­Ø³Ø§Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†."};
      if(!Number.isFinite(amount) || amount<=0) return {ok:false,msg:"Ù…Ø¨Ù„Øº Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯."};

      return {ok:true,data:{date,type,category,account,amount:Math.round(amount),note}};
    }

    function upsertTx(payload){
      if(state.editingTxId){
        const i=state.transactions.findIndex(t=>t.id===state.editingTxId);
        if(i>=0) state.transactions[i]={...state.transactions[i],...payload};
      }else{
        state.transactions.unshift({id:uid(),...payload});
      }
      save();
      render();
    }

    function deleteTx(id){
      state.transactions = state.transactions.filter(t=>t.id!==id);
      save();
      render();
    }

    el("txSave").addEventListener("click", ()=>{
      const v=validateTx();
      if(!v.ok){ alert(v.msg); return; }
      upsertTx(v.data);
      closeTxModal();
      showToast(state.editingTxId ? "ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯." : "Ø«Ø¨Øª Ø´Ø¯.");
    });

    // ---------- Debt modal ----------
    const modalDebt = el("modalDebt");
    function openDebtModal(mode, d=null){
      modalDebt.classList.add("open");
      if(mode==="add"){
        state.editingDebtId=null;
        el("dModePill").textContent="Ø«Ø¨Øª";
        el("dModalTitle").textContent="Ø«Ø¨Øª Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨";
        el("dfPerson").value="";
        el("dfDir").value="receivable";
        el("dfStart").value=todayISO();
        el("dfDue").value="";
        el("dfAmount").value="";
        el("dfStatus").value="open";
        el("dfNote").value="";
      }else{
        state.editingDebtId=d.id;
        el("dModePill").textContent="ÙˆÛŒØ±Ø§ÛŒØ´";
        el("dModalTitle").textContent="ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨";
        el("dfPerson").value=d.person||"";
        el("dfDir").value=d.dir;
        el("dfStart").value=d.startDate || todayISO();
        el("dfDue").value=d.dueDate || "";
        el("dfAmount").value=d.amount;
        el("dfStatus").value=d.status;
        el("dfNote").value=d.note||"";
      }
      setTimeout(()=>el("dfPerson").focus(),0);
    }
    function closeDebtModal(){ modalDebt.classList.remove("open"); }

    el("dClose").addEventListener("click", closeDebtModal);
    el("dCancel").addEventListener("click", closeDebtModal);
    modalDebt.addEventListener("click",(e)=>{ if(e.target===modalDebt) closeDebtModal(); });

    function validateDebt(){
      const person=el("dfPerson").value?.trim();
      const dir=el("dfDir").value;
      const startDate=el("dfStart").value?.trim();
      const dueDate=el("dfDue").value?.trim() || "";
      const amount=Number(el("dfAmount").value);
      const status=el("dfStatus").value;
      const note=el("dfNote").value?.trim()||"";

      if(!person) return {ok:false,msg:"Ù†Ø§Ù… Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
      if(dir!=="receivable" && dir!=="payable") return {ok:false,msg:"Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª."};
      if(!startDate) return {ok:false,msg:"ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
      if(dueDate && dueDate < "1900-01-01") return {ok:false,msg:"Ø³Ø±Ø±Ø³ÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª."};
      if(!Number.isFinite(amount) || amount<=0) return {ok:false,msg:"Ù…Ø¨Ù„Øº Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯."};
      if(status!=="open" && status!=="settled") return {ok:false,msg:"ÙˆØ¶Ø¹ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª."};

      return {ok:true,data:{person,dir,startDate,dueDate,amount:Math.round(amount),status,note}};
    }

    function upsertDebt(payload){
      if(state.editingDebtId){
        const i=state.debts.findIndex(x=>x.id===state.editingDebtId);
        if(i>=0) state.debts[i]={...state.debts[i],...payload, updatedAt: new Date().toISOString()};
      }else{
        state.debts.unshift({
          id: uid(),
          ...payload,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          settledAt: payload.status==="settled" ? new Date().toISOString() : ""
        });
      }
      // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Â«ØªØ³ÙˆÛŒÙ‡â€ŒØ´Ø¯Ù‡Â» Ø²Ø¯
      if(payload.status==="settled"){
        const d = state.debts.find(x=>x.id===state.editingDebtId) || state.debts[0];
        if(d) d.settledAt = d.settledAt || new Date().toISOString();
      }
      save();
      render();
    }

    function deleteDebt(id){
      state.debts = state.debts.filter(d=>d.id!==id);
      save();
      render();
    }

    el("dSave").addEventListener("click", ()=>{
      const v=validateDebt();
      if(!v.ok){ alert(v.msg); return; }
      upsertDebt(v.data);
      closeDebtModal();
      showToast(state.editingDebtId ? "ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯." : "Ø«Ø¨Øª Ø´Ø¯.");
    });

    // ---------- Render Transactions ----------
    function getFilteredTx(){
      const f = state.filters;
      return state.transactions.filter(t=>{
        if(f.month && monthISO(t.date)!==f.month) return false;
        if(f.type!=="all" && t.type!==f.type) return false;
        if(f.category!=="all" && t.category!==f.category) return false;
        if(f.q){
          const hay = `${t.note||""} ${t.category||""} ${t.account||""}`.toLowerCase();
          if(!hay.includes(f.q.toLowerCase())) return false;
        }
        return true;
      });
    }

    function sumTx(items,type){
      let s=0;
      for(const t of items) if(t.type===type) s += Number(t.amount)||0;
      return s;
    }

    function groupByCategory(items,type){
      const map=new Map();
      for(const t of items){
        if(t.type!==type) continue;
        const key=t.category||"Ø³Ø§ÛŒØ±";
        map.set(key,(map.get(key)||0)+(Number(t.amount)||0));
      }
      return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
    }

    function drawChart(items){
      const chart=el("chart");
      const ctx=chart.getContext("2d");
      const W=chart.width, H=chart.height;
      ctx.clearRect(0,0,W,H);

      const exp=groupByCategory(items,"expense").slice(0,6);
      const inc=groupByCategory(items,"income").slice(0,6);

      const leftPad=18, rightPad=18, topPad=18, bottomPad=44;
      const innerW=W-leftPad-rightPad;
      const innerH=H-topPad-bottomPad;

      const maxVal=Math.max(1, ...exp.map(x=>x[1]), ...inc.map(x=>x[1]));

      ctx.strokeStyle="rgba(255,255,255,.12)";
      ctx.lineWidth=1;

      // axes
      ctx.beginPath();
      ctx.moveTo(leftPad, topPad);
      ctx.lineTo(leftPad, topPad+innerH);
      ctx.lineTo(leftPad+innerW, topPad+innerH);
      ctx.stroke();

      // grid
      for(let i=1;i<=4;i++){
        const y=topPad+innerH-(innerH*i/4);
        ctx.beginPath();
        ctx.moveTo(leftPad,y);
        ctx.lineTo(leftPad+innerW,y);
        ctx.stroke();
      }

      const groups=[
        {title:"Ù‡Ø²ÛŒÙ†Ù‡", items:exp, x0:leftPad, x1:leftPad+innerW/2-8, color:"rgba(255,107,122,.50)"},
        {title:"Ø¯Ø±Ø¢Ù…Ø¯", items:inc, x0:leftPad+innerW/2+8, x1:leftPad+innerW, color:"rgba(122,169,255,.55)"}
      ];

      ctx.font="12px "+getComputedStyle(document.body).fontFamily;
      ctx.fillStyle="rgba(238,244,255,.9)";

      for(const g of groups){
        const gw=g.x1-g.x0;
        const n=Math.max(1,g.items.length);
        const barW=Math.max(10, Math.floor((gw-10)/(n*1.2)));
        const gap=Math.floor((gw-(barW*n))/(n+1));

        ctx.fillStyle="rgba(238,244,255,.9)";
        ctx.fillText(g.title, g.x0+6, topPad-2);

        for(let i=0;i<g.items.length;i++){
          const [name,val]=g.items[i];
          const h=Math.max(2, Math.round((val/maxVal)*innerH));
          const x=g.x0+gap+i*(barW+gap);
          const y=topPad+innerH-h;

          ctx.fillStyle=g.color;
          ctx.fillRect(x,y,barW,h);

          ctx.fillStyle="rgba(238,244,255,.85)";
          const label=name.length>6 ? name.slice(0,6)+"â€¦" : name;
          ctx.fillText(label, x, topPad+innerH+18);
        }
      }

      ctx.fillStyle="rgba(159,176,211,.9)";
      ctx.fillText("Ù†Ù…ÙˆØ¯Ø§Ø±: Ø¨Ø±ØªØ±ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡", leftPad, H-10);
    }

    function renderTx(){
      // inputs -> state
      state.filters.q = el("q").value.trim();
      state.filters.month = el("month").value || "";
      state.filters.type = el("typeFilter").value;
      state.filters.category = el("catFilter").value;

      const items = getFilteredTx();
      const income = sumTx(items,"income");
      const expense = sumTx(items,"expense");
      const net = income - expense;

      el("kpiIncome").textContent = nf.format(income);
      el("kpiExpense").textContent = nf.format(expense);
      el("kpiNet").textContent = nf.format(net);
      el("kpiCount").textContent = nf.format(items.length);

      el("activeMonthPill").textContent = `Ù…Ø§Ù‡: ${state.filters.month || "â€”"}`;

      const netPill = el("netPill");
      if(net>=0){ netPill.className="pill good"; netPill.textContent=`Ø®Ø§Ù„Øµ Ù…Ø«Ø¨Øª: ${nf.format(net)}`; }
      else { netPill.className="pill bad"; netPill.textContent=`Ø®Ø§Ù„Øµ Ù…Ù†ÙÛŒ: ${nf.format(Math.abs(net))}âˆ’`; }

      // top cats
      const topExp = groupByCategory(items,"expense")[0];
      const topInc = groupByCategory(items,"income")[0];

      if(topExp){ el("topExpenseCat").textContent=topExp[0]; el("topExpenseHint").textContent=`Ù…Ø¬Ù…ÙˆØ¹: ${nf.format(topExp[1])}`; }
      else { el("topExpenseCat").textContent="â€”"; el("topExpenseHint").textContent="Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡"; }

      if(topInc){ el("topIncomeCat").textContent=topInc[0]; el("topIncomeHint").textContent=`Ù…Ø¬Ù…ÙˆØ¹: ${nf.format(topInc[1])}`; }
      else { el("topIncomeCat").textContent="â€”"; el("topIncomeHint").textContent="Ø¯Ø±Ø¢Ù…Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡"; }

      // table
      const tb = el("txBody");
      tb.innerHTML="";
      if(items.length===0){
        tb.innerHTML = `<tr><td colspan="7" class="muted">Ú†ÛŒØ²ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. ÛŒÚ© ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øª Ú©Ù†.</td></tr>`;
      }else{
        for(const t of items){
          const typeLabel = t.type==="income" ? "Ø¯Ø±Ø¢Ù…Ø¯" : "Ù‡Ø²ÛŒÙ†Ù‡";
          const typePill = t.type==="income"
            ? `<span class="pill good">â†‘ ${typeLabel}</span>`
            : `<span class="pill bad">â†“ ${typeLabel}</span>`;

          const amountClass = t.type==="income" ? "in" : "out";
          const amountPrefix = t.type==="income" ? "+" : "âˆ’";

          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td class="nowrap">${escapeHtml(t.date)}</td>
            <td>${typePill}</td>
            <td><span class="tag">${escapeHtml(t.category)}</span></td>
            <td><span class="tag">${escapeHtml(t.account)}</span></td>
            <td>${t.note ? escapeHtml(t.note) : `<span class="muted">â€”</span>`}</td>
            <td class="nowrap amount ${amountClass}">${amountPrefix}${nf.format(t.amount)}</td>
            <td class="nowrap">
              <button class="iconBtn" data-act="tx_edit" data-id="${t.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button>
              <button class="iconBtn danger" data-act="tx_del" data-id="${t.id}">Ø­Ø°Ù</button>
            </td>`;
          tb.appendChild(tr);
        }
      }

      tb.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id=btn.getAttribute("data-id");
          const act=btn.getAttribute("data-act");
          const tx=state.transactions.find(x=>x.id===id);
          if(!tx) return;
          if(act==="tx_edit") openTxModal("edit",tx);
          if(act==="tx_del"){
            if(confirm("Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")){
              deleteTx(id); showToast("Ø­Ø°Ù Ø´Ø¯.");
            }
          }
        });
      });

      drawChart(items);
    }

    // ---------- Render Debts ----------
    function isOverdue(d){
      if(d.status!=="open") return false;
      if(!d.dueDate) return false;
      return d.dueDate < todayISO();
    }

    function getFilteredDebts(){
      const f=state.debtFilters;
      const q=f.q.toLowerCase();

      let items = state.debts.filter(d=>{
        if(f.status!=="all" && d.status!==f.status) return false;
        if(f.dir!=="all" && d.dir!==f.dir) return false;
        if(f.q){
          const hay = `${d.person||""} ${d.note||""}`.toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      // sort
      const toNum=(x)=>Number(x)||0;
      if(f.sort==="amount_desc"){
        items.sort((a,b)=>toNum(b.amount)-toNum(a.amount));
      }else if(f.sort==="created_desc"){
        items.sort((a,b)=>String(b.createdAt||"").localeCompare(String(a.createdAt||"")));
      }else{ // due_asc
        items.sort((a,b)=>{
          const ad=a.dueDate || "9999-12-31";
          const bd=b.dueDate || "9999-12-31";
          return ad.localeCompare(bd);
        });
      }
      return items;
    }

    function sumOpen(dir){
      let s=0;
      for(const d of state.debts){
        if(d.status!=="open") continue;
        if(d.dir===dir) s += Number(d.amount)||0;
      }
      return s;
    }

    function settleDebt(id){
      const d = state.debts.find(x=>x.id===id);
      if(!d) return;

      // Ø¢ÛŒØ§ ØªØ±Ø§Ú©Ù†Ø´ Ù‡Ù… Ø«Ø¨Øª Ø´ÙˆØ¯ØŸ
      const wantTx = confirm("ØªØ³ÙˆÛŒÙ‡ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯. Ø¢ÛŒØ§ ÛŒÚ© ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø±Ø¢Ù…Ø¯/Ù‡Ø²ÛŒÙ†Ù‡ Ù‡Ù… Ø«Ø¨Øª Ø´ÙˆØ¯ØŸ");
      if(wantTx){
        const type = d.dir==="receivable" ? "income" : "expense";
        const note = `ØªØ³ÙˆÛŒÙ‡ ${d.dir==="receivable" ? "Ø·Ù„Ø¨" : "Ø¨Ø¯Ù‡ÛŒ"}: ${d.person}${d.note ? " â€” "+d.note : ""}`;
        state.transactions.unshift({
          id: uid(),
          date: todayISO(),
          type,
          category: "ØªØ³ÙˆÛŒÙ‡ Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨",
          account: "Ø¨Ø§Ù†Ú©",
          amount: Math.round(Number(d.amount)||0),
          note
        });
      }

      d.status="settled";
      d.settledAt = new Date().toISOString();
      d.updatedAt = new Date().toISOString();

      save();
      render();
      showToast("ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯.");
    }

    function renderDebts(){
      state.debtFilters.q = el("dq").value.trim();
      state.debtFilters.dir = el("dDir").value;
      state.debtFilters.status = el("dStatus").value;
      state.debtFilters.sort = el("dSort").value;

      const openRecv = sumOpen("receivable");
      const openPay = sumOpen("payable");
      const net = openRecv - openPay;

      const overdueCount = state.debts.filter(isOverdue).length;

      el("kpiRecv").textContent = nf.format(openRecv);
      el("kpiPay").textContent = nf.format(openPay);
      el("kpiDebtNet").textContent = nf.format(net);
      el("kpiOverdue").textContent = nf.format(overdueCount);

      const pill = el("debtPill");
      if(net>0){ pill.className="pill good"; pill.textContent=`Ø·Ù„Ø¨ Ø®Ø§Ù„Øµ: ${nf.format(net)}`; }
      else if(net<0){ pill.className="pill bad"; pill.textContent=`Ø¨Ø¯Ù‡ÛŒ Ø®Ø§Ù„Øµ: ${nf.format(Math.abs(net))}âˆ’`; }
      else { pill.className="pill"; pill.textContent="Ø®Ø§Ù„Øµ: Û°"; }

      const items = getFilteredDebts();
      const tb = el("debtBody");
      tb.innerHTML="";

      if(items.length===0){
        tb.innerHTML = `<tr><td colspan="7" class="muted">Ù…ÙˆØ±Ø¯ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. ÛŒÚ© Ø¨Ø¯Ù‡ÛŒ/Ø·Ù„Ø¨ Ø«Ø¨Øª Ú©Ù†.</td></tr>`;
        return;
      }

      for(const d of items){
        const dirLabel = d.dir==="receivable" ? "Ø·Ù„Ø¨" : "Ø¨Ø¯Ù‡ÛŒ";
        const dirPill = d.dir==="receivable"
          ? `<span class="pill good">â¬† ${dirLabel}</span>`
          : `<span class="pill bad">â¬‡ ${dirLabel}</span>`;

        const statusPill = d.status==="open"
          ? (isOverdue(d)
              ? `<span class="pill warn">â° Ø³Ø±Ø±Ø³ÛŒØ¯ Ú¯Ø°Ø´ØªÙ‡</span>`
              : `<span class="pill">Ø¨Ø§Ø²</span>`)
          : `<span class="pill good">âœ“ ØªØ³ÙˆÛŒÙ‡</span>`;

        const due = d.dueDate ? escapeHtml(d.dueDate) : `<span class="muted">â€”</span>`;
        const noteLine = d.note ? `<div class="small muted" style="margin-top:4px">${escapeHtml(d.note)}</div>` : "";

        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>
            <div style="font-weight:1000">${escapeHtml(d.person)}</div>
            ${noteLine}
          </td>
          <td class="nowrap">${dirPill}</td>
          <td class="nowrap">${escapeHtml(d.startDate || "â€”")}</td>
          <td class="nowrap">${due}</td>
          <td class="nowrap">${nf.format(d.amount)}</td>
          <td class="nowrap">${statusPill}</td>
          <td class="nowrap">
            <button class="iconBtn" data-act="d_edit" data-id="${d.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button>
            ${d.status==="open" ? `<button class="iconBtn primary" data-act="d_settle" data-id="${d.id}">ØªØ³ÙˆÛŒÙ‡</button>` : ""}
            <button class="iconBtn danger" data-act="d_del" data-id="${d.id}">Ø­Ø°Ù</button>
          </td>`;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id=btn.getAttribute("data-id");
          const act=btn.getAttribute("data-act");
          const d=state.debts.find(x=>x.id===id);
          if(!d) return;

          if(act==="d_edit") openDebtModal("edit", d);
          if(act==="d_settle") settleDebt(id);
          if(act==="d_del"){
            if(confirm("Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")){
              deleteDebt(id); showToast("Ø­Ø°Ù Ø´Ø¯.");
            }
          }
        });
      });
    }

    // ---------- Main render ----------
    function render(){
      if(state.activeTab==="tx") renderTx();
      else renderDebts();
    }

    // ---------- Main buttons ----------
    el("btnAddMain").addEventListener("click", ()=>{
      if(state.activeTab==="tx") openTxModal("add");
      else openDebtModal("add");
    });

    // Tx filters
    ["q","month","typeFilter","catFilter"].forEach(id=>{
      const e=el(id);
      e.addEventListener("input", render);
      e.addEventListener("change", render);
    });

    // Debt filters
    ["dq","dDir","dStatus","dSort"].forEach(id=>{
      const e=el(id);
      e.addEventListener("input", render);
      e.addEventListener("change", render);
    });

    // ---------- Backup / Restore ----------
    function downloadJSON(){
      const data = {
        exportedAt: new Date().toISOString(),
        version: 2,
        transactions: state.transactions,
        debts: state.debts
      };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download=`backup-accounting-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("Ø¨Ú©Ø§Ù¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯.");
    }

    function restoreFromFile(file){
      const r=new FileReader();
      r.onload=()=>{
        try{
          const p=JSON.parse(String(r.result||"{}"));
          const txs = Array.isArray(p.transactions) ? p.transactions : [];
          const debts = Array.isArray(p.debts) ? p.debts : [];

          const cleanedTx = txs
            .filter(t=>t && t.id && t.date && t.type && t.category && t.account && Number.isFinite(Number(t.amount)))
            .map(t=>({
              id:String(t.id),
              date:String(t.date).slice(0,10),
              type: t.type==="income" ? "income" : "expense",
              category:String(t.category),
              account:String(t.account),
              amount:Math.round(Number(t.amount)),
              note: t.note ? String(t.note) : ""
            }));

          const cleanedDebts = debts
            .filter(d=>d && d.id && d.person && d.dir && d.startDate && Number.isFinite(Number(d.amount)))
            .map(d=>({
              id:String(d.id),
              person:String(d.person),
              dir: d.dir==="payable" ? "payable" : "receivable",
              startDate:String(d.startDate).slice(0,10),
              dueDate: d.dueDate ? String(d.dueDate).slice(0,10) : "",
              amount:Math.round(Number(d.amount)),
              status: d.status==="settled" ? "settled" : "open",
              note: d.note ? String(d.note) : "",
              createdAt: d.createdAt ? String(d.createdAt) : "",
              updatedAt: d.updatedAt ? String(d.updatedAt) : "",
              settledAt: d.settledAt ? String(d.settledAt) : ""
            }));

          state.transactions=cleanedTx;
          state.debts=cleanedDebts;

          save();
          render();
          showToast("Ø¨Ú©Ø§Ù¾ ÙˆØ§Ø±Ø¯ Ø´Ø¯.");
        }catch{
          alert("ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
        }
      };
      r.readAsText(file);
    }

    el("btnBackup").addEventListener("click", downloadJSON);
    el("btnRestore").addEventListener("click", ()=>el("restoreFile").click());
    el("restoreFile").addEventListener("change",(e)=>{
      const file = e.target.files && e.target.files[0];
      if(file) restoreFromFile(file);
      e.target.value="";
    });

    el("btnReset").addEventListener("click", ()=>{
      if(!confirm("Ù‡Ù…Ù‡â€ŒÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ Ø§ÛŒÙ† Ú©Ø§Ø± Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª.")) return;
      state.transactions=[];
      state.debts=[];
      save();
      render();
      showToast("Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
    });

    // shortcuts
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){
        if(modalTx.classList.contains("open")) closeTxModal();
        if(modalDebt.classList.contains("open")) closeDebtModal();
      }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="k"){
        e.preventDefault();
        if(state.activeTab==="tx") el("q").focus(); else el("dq").focus();
      }
    });

    // ---------- Init ----------
    load();
    fillDropdowns();
    seed();
    setTab("tx"); // renders
  </script>
</body>
</html>
